const { PDFDocument, StandardFonts, rgb } = require("pdf-lib");

module.exports = async function generateClientReportPdf(client) {
  const pdfDoc = await PDFDocument.create();
  const page = pdfDoc.addPage([612, 792]); // Letter size
  const { height } = page.getSize();

  const font = await pdfDoc.embedFont(StandardFonts.Helvetica);

  let y = height - 50;

  const drawText = (text, size = 12) => {
    page.drawText(text, {
      x: 50,
      y,
      size,
      font,
      color: rgb(0, 0, 0),
    });
    y -= size + 8;
  };

  // ===== HEADER =====
  drawText("VitaLink – Client Information Summary", 18);
  y -= 10;
  drawText(`Generated: ${new Date().toLocaleDateString()}`, 10);
  y -= 20;

  // ===== CLIENT INFO =====
  drawText("Client Information", 14);
  y -= 5;
  drawText(`Name: ${client.name || "N/A"}`);
  drawText(`DOB: ${client.dob || "N/A"}`);
  drawText(`Phone: ${client.phone || "N/A"}`);
  drawText(`Email: ${client.email || "N/A"}`);
  y -= 20;

  // ===== MEDICATIONS =====
  drawText("Medications", 14);
  y -= 5;

  if (Array.isArray(client.medications) && client.medications.length) {
    client.medications.forEach((m, i) => {
      drawText(
        `${i + 1}. ${m.name || "Unknown"} — ${m.dose || ""} ${m.frequency || ""}`
      );
    });
  } else {
    drawText("No medications listed.");
  }

  y -= 20;

  // ===== PROVIDERS =====
  drawText("Healthcare Providers", 14);
  y -= 5;

  if (Array.isArray(client.providers) && client.providers.length) {
    client.providers.forEach((p, i) => {
      drawText(
        `${i + 1}. ${p.name || "Unknown"} (${p.specialty || "N/A"}) — ${p.phone || ""}`
      );
    });
  } else {
    drawText("No providers listed.");
  }

  y -= 30;

  // ===== FOOTER =====
  drawText(
    "This report was generated by VitaLink for authorized agent use only.",
    9
  );

  const pdfBytes = await pdfDoc.save();
  return Buffer.from(pdfBytes);
};
