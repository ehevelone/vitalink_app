const PDFDocument = require("pdfkit");
const path = require("path");

module.exports = function generateClientReportPdf(client) {
  return new Promise((resolve, reject) => {
    try {
      const doc = new PDFDocument({
        margin: 50,
        autoFirstPage: true,
      });

      const chunks = [];

      doc.on("data", (c) => chunks.push(c));
      doc.on("end", () => resolve(Buffer.concat(chunks)));

      // ðŸ”¹ Register custom font BEFORE using any text
      const fontPath = path.join(__dirname, "Roboto-Regular.ttf");
      doc.registerFont("Roboto", fontPath);
      doc.font("Roboto");

      // ===== HEADER =====
      doc
        .fontSize(18)
        .text("VitaLink â€“ Client Information Summary", { align: "center" })
        .moveDown(0.5);

      doc
        .fontSize(10)
        .text(`Generated: ${new Date().toLocaleDateString()}`, {
          align: "center",
        });

      doc.moveDown(2);

      // ===== CLIENT INFO =====
      doc.fontSize(14).text("Client Information");
      doc.moveDown(0.5);

      doc.fontSize(11);
      doc.text(`Name: ${client.name || "N/A"}`);
      doc.text(`DOB: ${client.dob || "N/A"}`);
      doc.text(`Phone: ${client.phone || "N/A"}`);
      doc.text(`Email: ${client.email || "N/A"}`);

      doc.moveDown(2);

      // ===== MEDICATIONS =====
      doc.fontSize(14).text("Medications");
      doc.moveDown(0.5);

      if (Array.isArray(client.medications) && client.medications.length) {
        client.medications.forEach((m, i) => {
          doc.fontSize(11).text(
            `${i + 1}. ${m.name || "Unknown"} â€” ${m.dose || ""} ${m.frequency || ""}`
          );
        });
      } else {
        doc.fontSize(11).text("No medications listed.");
      }

      doc.moveDown(2);

      // ===== PROVIDERS =====
      doc.fontSize(14).text("Healthcare Providers");
      doc.moveDown(0.5);

      if (Array.isArray(client.providers) && client.providers.length) {
        client.providers.forEach((p, i) => {
          doc.fontSize(11).text(
            `${i + 1}. ${p.name || "Unknown"} (${p.specialty || "N/A"}) â€” ${p.phone || ""}`
          );
        });
      } else {
        doc.fontSize(11).text("No providers listed.");
      }

      // ===== FOOTER =====
      doc.moveDown(3);
      doc
        .fontSize(9)
        .text(
          "This report was generated by VitaLink for authorized agent use only.",
          { align: "center" }
        );

      doc.end();
    } catch (err) {
      reject(err);
    }
  });
};
